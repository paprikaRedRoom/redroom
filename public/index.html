<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Overlay</title>
    <!-- FONT IMPORTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Kalam:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* 
        ==========================================================================
        DESIGN - Girly Stream Room
        ==========================================================================
        */
        :root {
            --primary-color: #ff85a2;   /* Soft Pink */
            --secondary-color: #a2d2ff; /* Pastel Blue */
            --background-color: #fce4ec; /* Light Pink Background */
            --text-color: #333;         /* Dark Grey Text */
            --accent-color: #ffffff;    /* White */
            
            --title-font: 'Kalam', cursive;
            --body-font: 'Poppins', sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 1366px; /* For OBS */
            height: 768px; /* For OBS */
            font-family: var(--body-font);
            background-color: var(--background-color);
            background-image: url('https://www.publicdomainpictures.net/pictures/310000/velka/abstract-background-156811269522v.jpg'); /* Girly room background */
            background-size: cover;
            background-position: center;
            color: var(--text-color);
            overflow: hidden;
            position: relative;
        }

        /* 
        ==========================================================================
        TOKEN INFO STYLING (NEW)
        ==========================================================================
        */
        .token-info {
            position: absolute;
            top: 20px;
            left: 47%;
            transform: translateX(-50%);
            z-index: 5;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 15px 30px;
            border-radius: 15px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .token-name {
            font-family: var(--title-font);
            font-size: 3.5rem; /* Larger font for the name */
            color: var(--primary-color);
            text-shadow: 2px 2px 3px rgba(0,0,0,0.1);
            line-height: 1;
            margin: 0;
        }

        .token-ca {
            font-family: var(--body-font);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            background-color: rgba(0,0,0,0.05);
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: inline-block; /* To contain background */
            word-break: break-all; /* Ensure long CAs don't overflow */
        }
        
        /* 
        ==========================================================================
        MAIN CHARACTER STYLING
        ==========================================================================
        */
        .character-container {
            display: flex;
            justify-content: center;
            align-items: center; /* Vertically centers content */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #girl-character {
            max-width: 85%;
            max-height: 85%;
            object-fit: contain;
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.2));
            margin-top: 60px; /* Pushes character down slightly to avoid text */
            border-radius: 25px;
            margin-right: 100px;
        }
        
        /* 
        ==========================================================================
        LIVE CHAT STYLING
        ==========================================================================
        */
        .chat-window {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        .chat-header {
            font-family: var(--title-font);
            font-size: 1.8rem;
            text-align: center;
            padding: 10px;
            background-color: var(--primary-color);
            color: var(--accent-color);
            flex-shrink: 0;
        }
        
        #turn-on-button {
            width: 80%;
            height: 45px;
            margin: 20px auto;
            background: var(--primary-color);
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: var(--accent-color);
            font-size: 18px;
            font-family: var(--body-font);
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        #turn-on-button:hover {
            transform: translateY(-2px);
            background-color: #ff6b8f;
        }
        
        #chat-container {
            scrollbar-width: none; /* For Firefox */
            flex-grow: 1;
            padding: 10px;
            overflow-y: hidden;
            display: flex;
            flex-direction: column-reverse;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            animation: slideIn 0.4s ease-out;
            word-wrap: break-word;
            font-size: 0.95rem;
            border-left: 4px solid var(--secondary-color);
        }

        .username {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 5px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    
    <!-- Token Name and CA -->
    <div class="token-info">
        <h1 class="token-name">$Rem</h1>
        <p class="token-ca">CA: 3n3iPvWx6KyBKZfX42GyP5ZUQYXpRfz1L1ztaeVurpyw</p>
    </div>

    <!-- Main character -->
    <div class="character-container">
        <img id="girl-character" src="./still.png" alt="A friendly girl character">
    </div>

    <!-- Live chat window -->
    <div class="chat-window">
        <h2 class="chat-header">Live Chat</h2>
        <button id="turn-on-button">Start Chat</button>
        <div id="chat-container">
            <div id="chat-messages"></div>
        </div>
    </div>
    
    <!-- This script handles page logic. IT REMAINS UNTOUCHED. -->
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
          // --- DYNAMIC TITLE CHANGER (Unchanged) ---
          const quotes = ["Stay hydrated!", "Don't forget to smile :)", "Sending virtual hugs!", "Thanks for being here!", "Let's have some fun!", "You are awesome!"];
          const titleElement = document.getElementById('main-title'); // This element is no longer in the HTML, this will gracefully fail.
          if (titleElement) {
            let quoteIndex = 0;
            setInterval(() => {
                quoteIndex = (quoteIndex + 1) % quotes.length;
                titleElement.style.opacity = 0;
                setTimeout(() => { titleElement.textContent = quotes[quoteIndex]; titleElement.style.opacity = 1; }, 500);
            }, 7000);
          }
          
          // --- CORE PAGE LOGIC (Mostly Unchanged) ---
          const buttonTurnOn = document.getElementById('turn-on-button');
          let buttonClicked = false, lastTimePlayed = Date.now();
          buttonTurnOn.onclick = () => { buttonClicked = true; buttonTurnOn.style.display = 'none'; };
          
          const chatMessages = document.getElementById('chat-messages');
          function addMessage(username, userMessage) {
              const messageElement = document.createElement('div');
              messageElement.className = 'chat-message';
              messageElement.innerHTML = `<span class="username">${username}:</span> ${userMessage}`;
              // Prepend to show new messages at the top of the container (which is visually the bottom)
              chatMessages.insertBefore(messageElement, chatMessages.firstChild); 
              if (chatMessages.children.length > 7) { 
                  chatMessages.removeChild(chatMessages.lastChild); 
              }
          }
          
          async function showIntro(){
              if(lastTimePlayed + 20000 < Date.now() && buttonClicked){ 
                  lastTimePlayed = Date.now();
                  if (window.currentAudio && !window.currentAudio.paused) return;
                  const introAudio = './audio/intro.mp3';
                  // Changed text to fit a girl character
                  const introText = "Hey everyone! So glad you could make it to the stream today. Let's have some fun together!";
                  try { await window.talker(introText, introAudio, 'happy'); } 
                  catch (error) { console.error("Intro sequence failed:", error); }
              }
          }
          setInterval(showIntro, 1000);
          
          const messageQueue = [];
          let isProcessing = false;
          async function processQueue() {
              if (messageQueue.length === 0) { isProcessing = false; return; }
              isProcessing = true;
              const receivedData = messageQueue.shift();
              if(receivedData.username !== "super_admin_04"){ addMessage(receivedData.username, receivedData.userMessage); }
              if(receivedData.audio && receivedData.message && buttonClicked) {
                  lastTimePlayed = Date.now();
                  try { await window.talker(receivedData.message, `data:audio/mp3;base64,${receivedData.audio}`); } 
                  catch (error) { console.error("Message sequence failed:", error); }
              }
              processQueue();
          }
          
          class RobustWebSocketClient {
              constructor() { this.ws = null; this.url = "ws://localhost:8000"; this.reconnectDelay = 2000; }
              connect() {
                  if (this.ws && this.ws.readyState === WebSocket.OPEN) return;
                  this.ws = new WebSocket(this.url);
                  this.ws.onopen = () => console.log("[WebSocket] Connection established.");
                  this.ws.onmessage = (event) => { messageQueue.push(JSON.parse(event.data)); if (!isProcessing) processQueue(); };
                  this.ws.onclose = () => { setTimeout(() => this.connect(), this.reconnectDelay); };
                  this.ws.onerror = (err) => { console.error("[WebSocket] Error:", err); this.ws.close(); };
              }
          }
          new RobustWebSocketClient().connect();

          // test chat
        //   setInterval(() => {
        //       if(buttonClicked){
        //           const testUsers = ["Alice", "Bob", "Charlie", "Diana", "Eve"];
        //           const randomUser = testUsers[Math.floor(Math.random() * testUsers.length)];
        //           const randomMessage = "This is a test message!";
        //           addMessage(randomUser, randomMessage);
        //       }
        //   }, 1000);
      });

      /**
       * MODIFIED: Character Talker Function
       * This function now controls the <img> tag for the girl character.
       */
      window.talker = function(text, audioSrc) {
          return new Promise((resolve, reject) => {
              const girlImage = document.getElementById('girl-character'); // Changed ID
              if (!girlImage) {
                  console.error("Girl image element not found!");
                  reject("Girl image missing.");
                  return;
              }

              // Change to the talking GIF immediately
              girlImage.src = './move.gif';

              if (window.currentAudio) { window.currentAudio.pause(); }
              window.currentAudio = new Audio(audioSrc);

              // Event handler for when the audio finishes playing
              window.currentAudio.onended = () => {
                  girlImage.src = './still.png'; // Change back to the still image
                  resolve(); // Signal that the sequence is complete
              };
              
              // Event handler for any audio playback errors
              window.currentAudio.onerror = (err) => {
                  console.error("Audio playback error:", err);
                  girlImage.src = './still.png'; // Change back even if there's an error
                  reject("Failed to play audio.");
              };

              // Play the audio
              window.currentAudio.play().catch(reject);
          });
      }
    </script>

</body>
</html>